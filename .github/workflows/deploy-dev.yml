name: Deploy DEV to Cloudflare Workers

on:
  push:
    branches:
      - dev  # Triggers only on dev branch
  workflow_dispatch:  # Allows manual workflow run

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      # Deploy all dev workers
      - name: Deploy dev-telegram-webhook
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          command: deploy --env dev-webhook --keep-vars
          
      - name: Deploy dev-test-bot
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          command: deploy --env dev-test-bot --keep-vars
          
      - name: Deploy dev-main-lesson
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          command: deploy --env dev-main-lesson --keep-vars
          
      - name: Deploy dev-reminder
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          command: deploy --env dev-reminder --keep-vars
          
      # Deploy dev-lesson0 with secret setup
      - name: Setup and deploy dev-lesson0-bot
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          echo "Настройка и деплой dev-lesson0-bot..."
          
          # Deploy dev lesson0 bot
          npx wrangler deploy --env dev-lesson0 --keep-vars
          
          # Check for secrets and set them if needed
          SECRETS=$(npx wrangler secret list --env dev-lesson0)
          
          if ! echo "$SECRETS" | grep -q "DEV_BOT_TOKEN"; then
            echo "Устанавливаем DEV_BOT_TOKEN..."
            echo "${{ secrets.DEV_BOT_TOKEN }}" | npx wrangler secret put BOT_TOKEN --env dev-lesson0
          fi
          
          if ! echo "$SECRETS" | grep -q "OPENAI_KEY"; then
            echo "Устанавливаем OPENAI_KEY..."
            echo "${{ secrets.OPENAI_KEY }}" | npx wrangler secret put OPENAI_KEY --env dev-lesson0
          fi
          
          if ! echo "$SECRETS" | grep -q "TRANSLOADIT_KEY"; then
            echo "Устанавливаем TRANSLOADIT_KEY..."
            echo "${{ secrets.TRANSLOADIT_KEY }}" | npx wrangler secret put TRANSLOADIT_KEY --env dev-lesson0
          fi
          
          if ! echo "$SECRETS" | grep -q "TRANSLOADIT_TPL"; then
            echo "Устанавливаем TRANSLOADIT_TPL..."
            echo "${{ secrets.TRANSLOADIT_TPL }}" | npx wrangler secret put TRANSLOADIT_TPL --env dev-lesson0
          fi

      # Info about manual variable setup
      - name: Note about dev environment variables
        run: |
          echo "✅ DEV среда деплоится с флагом --keep-vars"
          echo "⚠️ ВАЖНО: Для dev среды используйте отдельные секреты:"
          echo "- DEV_BOT_TOKEN: токен dev бота"
          echo "- Те же OPENAI_KEY, TRANSLOADIT_KEY, TRANSLOADIT_TPL что и для продакшн"
          echo "- Настройте переменные через Cloudflare Dashboard для dev воркеров" 